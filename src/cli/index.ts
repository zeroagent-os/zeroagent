#!/usr/bin/env node
import { Command } from 'commander';
import chalk from 'chalk';
import { bootAgent, agentInstall, agentRun, agentRemove, agentStatus, agentList, agentSchedule, agentTrigger } from '../core/agent.js';

const program = new Command();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ZERO AGENT CLI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .name('zeroagent')
  .description('Your personal AI agent. No coding required.')
  .version('0.1.0');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BOOT
// zeroagent start
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('start')
  .description('Boot your ZERO AGENT')
  .action(async () => {
    await bootAgent();
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INSTALL
// zeroagent install skills:btc-price-tracker
// zeroagent install github:username/skill-name
// zeroagent install npm:skill-package
// zeroagent install https://github.com/org/repo --skill skill-name
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('install <source>')
  .description('Install a skill from skills.sh, GitHub, npm or any URL')
  .option('--skill <name>', 'Skill name (required for URL installs)')
  .action(async (source: string, options: { skill?: string }) => {
    await agentInstall(source, options.skill);
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RUN
// zeroagent run btc-price-tracker
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('run <skillName>')
  .description('Run an installed skill')
  .option('--input <json>', 'Input data as JSON string')
  .action(async (skillName: string, options: { input?: string }) => {
    let inputs: Record<string, unknown> = {};
    if (options.input) {
      try {
        inputs = JSON.parse(options.input);
      } catch {
        console.log(chalk.red('âŒ Invalid JSON input. Use: --input \'{"key":"value"}\''));
        return;
      }
    }
    await agentRun(skillName, inputs);
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LIST
// zeroagent list
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('list')
  .description('List all installed skills')
  .action(async () => {
    await agentList();
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REMOVE
// zeroagent remove btc-price-tracker
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('remove <skillName>')
  .description('Remove an installed skill')
  .action(async (skillName: string) => {
    await agentRemove(skillName);
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATUS
// zeroagent status
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('status')
  .description('Show agent status and running skills')
  .action(async () => {
    await agentStatus();
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIND
// zeroagent find "btc price tracker"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('find <query>')
  .description('Find skills from across the internet')
  .action(async (query: string) => {
    console.log(chalk.bold(`\nğŸ” Searching for skills: "${query}"\n`));
    console.log(chalk.dim('Powered by find-skills from Vercel Labs\n'));

    try {
      const { execSync } = await import('child_process');
      execSync(`npx skills find ${query}`, { stdio: 'inherit' });
    } catch {
      console.log(chalk.yellow('\nğŸ’¡ Tip: Try different keywords or browse skills.sh directly.'));
      console.log(chalk.cyan('   https://skills.sh\n'));
    }
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCHEDULE
// zeroagent schedule btc-price-tracker "*/15 * * * *"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('schedule <skillName> <cron>')
  .description('Run a skill on a schedule (Cloud tier required)')
  .addHelpText('after', `
Examples:
  zeroagent schedule btc-price-tracker "*/15 * * * *"   Every 15 minutes
  zeroagent schedule sales-report "0 9 * * *"           Every day at 9am
  zeroagent schedule price-check "0 * * * *"            Every hour`)
  .action(async (skillName: string, cron: string) => {
    await agentSchedule(skillName, cron);
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRIGGER
// zeroagent trigger btc-price-tracker "btc_price < 80000"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('trigger <skillName> <condition>')
  .description('Run a skill when a condition is met (Cloud tier required)')
  .option('--value <value>', 'Threshold value for the condition')
  .addHelpText('after', `
Examples:
  zeroagent trigger btc-alert "btc_price < 80000" --value 80000
  zeroagent trigger stock-alert "price > 200" --value 200`)
  .action(async (
    skillName: string,
    condition: string,
    options: { value?: string }
  ) => {
    const value = options.value ? parseFloat(options.value) || options.value : condition;

    // Basic check function â€” skill defines its own real check logic
    const checkFn = async (): Promise<boolean> => {
      try {
        const skillPath = `${process.env.HOME}/.zeroagent/skills/${skillName}/index.js`;
        const skillModule = await import(skillPath);
        if (typeof skillModule.check === 'function') {
          return await skillModule.check(value);
        }
        return false;
      } catch {
        return false;
      }
    };

    await agentTrigger(skillName, condition, value, checkFn);
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UPGRADE
// zeroagent upgrade
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('upgrade')
  .description('Upgrade to Cloud tier for unlimited skills and scheduled execution')
  .action(() => {
    console.log(chalk.bold('\nâ˜ï¸  Upgrade to ZERO AGENT Cloud\n'));
    console.log('  Unlimited skills');
    console.log('  Scheduled skills â€” run on a timer');
    console.log('  Triggered skills â€” run on a condition');
    console.log('  Managed hosting â€” no server needed');
    console.log(chalk.cyan('\n  ğŸ‘‰ zeroagentos.com\n'));
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WHOAMI
// zeroagent whoami
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program
  .command('whoami')
  .description('Show your agent details')
  .action(async () => {
    await agentStatus();
  });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HANDLE UNKNOWN COMMANDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

program.on('command:*', () => {
  console.log(chalk.red(`\nâŒ Unknown command: ${program.args.join(' ')}`));
  console.log(chalk.dim('\nRun zeroagent --help to see available commands.\n'));
  process.exit(1);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SHOW HELP IF NO COMMAND
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if (process.argv.length < 3) {
  console.log(chalk.bold('\nğŸ¤– ZERO AGENT\n'));
  console.log(chalk.dim('Your personal AI agent. No coding required.\n'));
  program.help();
}

program.parse(process.argv);
